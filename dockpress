node {
  def aws_ecr_url = ""
  def aws_ecr_repo = ""
  def aws_ecr_login_cmd = 'aws ecr get-login'
  def aws_ecr_image_path = "${aws_ecr_repo}:${env.JOB_BASE_NAME}-${env.BUILD_NUMBER}"

  stage 'Build and Package Docker image'
  git "${GIT_SOURCE_REPO}"

  stage 'Package Docker image'
  def img = docker.build('redeployio/jupiter:latest', '.')

  stage 'Publish'
  echo "Publishing docker container"
  sh "\$(${aws_ecr_login_cmd})"
  sh "docker tag ${aws_ecr_image_path} ${aws_ecr_url}/${aws_ecr_image_path}"
  sh "docker push ${aws_ecr_url}/${aws_ecr_image_path}"

docker.withRegistry('https://registry.hub.docker.com', 'docker-hub') {
    img.push('latest')
  }
}
